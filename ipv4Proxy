#!/bin/bash
# 3proxy IPv4 Proxy Server for AWS EC2
# Suitable for providers WITHOUT /64 IPv6 support
# Usage: sudo bash install_3proxy_ipv4.sh

PATH=/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

if [[ $EUID -ne 0 ]]; then
   echo -e "${RED}[ERROR] Run as root: sudo bash $0${NC}"
   exit 1
fi

clear
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}   3proxy IPv4 Proxy Server (AWS)${NC}"
echo -e "${BLUE}=========================================${NC}"
echo ""

REAL_USER=${SUDO_USER:-ec2-user}

echo -e "${YELLOW}[*] Installing dependencies...${NC}"
dnf install -y gcc make wget tar curl >/dev/null 2>&1
echo -e "${GREEN}[‚úì] Dependencies installed${NC}"

IFACE=$(ip route get 8.8.8.8 2>/dev/null | awk '{print $5; exit}')
IP4=$(curl -4 -s --max-time 10 icanhazip.com 2>/dev/null)

if [[ -z "$IP4" ]]; then
    echo -e "${RED}[ERROR] Cannot detect IPv4${NC}"
    exit 1
fi

echo -e "${GREEN}[+] Interface: $IFACE${NC}"
echo -e "${GREEN}[+] IPv4: $IP4${NC}"

FIRST_PORT=22000
LAST_PORT=22700
PROXY_COUNT=$((LAST_PORT - FIRST_PORT + 1))

echo ""
echo -e "${YELLOW}‚ö†Ô∏è  NOTE: This is IPv4-only proxy${NC}"
echo -e "  ‚Ä¢ Port range: $FIRST_PORT - $LAST_PORT"
echo -e "  ‚Ä¢ Number of proxies: $PROXY_COUNT"
echo -e "  ‚Ä¢ All proxies share same IPv4: $IP4"
echo ""

read -p "Press Enter to continue or Ctrl+C to cancel..."

random() {
    tr </dev/urandom -dc A-Za-z0-9 | head -c8
    echo
}

install_3proxy() {
    echo ""
    echo -e "${YELLOW}[*] Downloading 3proxy...${NC}"
    
    WORKDIR="/tmp/3proxy-install"
    mkdir -p "$WORKDIR"
    cd "$WORKDIR"
    
    wget -q --show-progress https://github.com/z3APA3A/3proxy/archive/refs/tags/0.9.4.tar.gz -O 3proxy.tar.gz
    tar -xzf 3proxy.tar.gz
    cd 3proxy-0.9.4
    
    echo -e "${YELLOW}[*] Compiling...${NC}"
    make -f Makefile.Linux >/dev/null 2>&1
    
    mkdir -p /usr/local/etc/3proxy/{bin,logs,stat}
    cp src/3proxy /usr/local/etc/3proxy/bin/
    chmod +x /usr/local/etc/3proxy/bin/3proxy
    
    cd /
    rm -rf "$WORKDIR"
    
    echo -e "${GREEN}[‚úì] 3proxy installed${NC}"
}

gen_3proxy() {
cat <<EOF
daemon
maxconn 4000
nserver 1.1.1.1
nserver 8.8.8.8
nscache 65536
timeouts 1 5 30 60 180 1800 15 60
setgid 65535
setuid 65535
stacksize 6291456
flush
auth strong

users $(awk -F "/" 'BEGIN{ORS="";} {print $1 ":CL:" $2 " "}' ${WORKDATA})

$(awk -F "/" '{print "allow " $1 "\nproxy -n -a -p" $4 " -i" $3 "\nflush\n"}' ${WORKDATA})
EOF
}

gen_proxy_file() {
    echo "# 3proxy IPv4 Proxy List" > proxy.txt
    echo "# Format: IP:PORT:USERNAME:PASSWORD" >> proxy.txt
    echo "# Generated: $(date)" >> proxy.txt
    echo "# Total: $PROXY_COUNT (all share same IPv4)" >> proxy.txt
    echo "" >> proxy.txt
    awk -F "/" '{print $3 ":" $4 ":" $1 ":" $2 }' ${WORKDATA} >> proxy.txt
}

gen_data() {
    seq $FIRST_PORT $LAST_PORT | while read port; do
        echo "user$port/$(random)/$IP4/$port"
    done
}

PROXY_DIR="/home/$REAL_USER/3proxy"
WORKDATA="${PROXY_DIR}/data.txt"

echo -e "${YELLOW}[*] Creating config in $PROXY_DIR${NC}"
mkdir -p "$PROXY_DIR"
cd "$PROXY_DIR"

install_3proxy

echo -e "${YELLOW}[*] Generating configs...${NC}"
gen_data > "$WORKDATA"
gen_3proxy > /usr/local/etc/3proxy/3proxy.cfg
echo -e "${GREEN}[‚úì] Config created${NC}"

echo -e "${YELLOW}[*] Creating systemd service...${NC}"
cat > /etc/systemd/system/3proxy.service <<EOF
[Unit]
Description=3proxy IPv4 proxy server
After=network.target

[Service]
Type=simple
ExecStart=/usr/local/etc/3proxy/bin/3proxy /usr/local/etc/3proxy/3proxy.cfg
Restart=on-failure
RestartSec=5
LimitNOFILE=65536

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable 3proxy >/dev/null 2>&1
echo -e "${GREEN}[‚úì] Service created${NC}"

echo -e "${YELLOW}[*] Configuring firewall...${NC}"
if ! command -v firewall-cmd &> /dev/null; then
    dnf install -y firewalld >/dev/null 2>&1
    systemctl start firewalld
    systemctl enable firewalld >/dev/null 2>&1
fi

if systemctl is-active --quiet firewalld; then
    firewall-cmd --permanent --add-port=${FIRST_PORT}-${LAST_PORT}/tcp >/dev/null 2>&1
    firewall-cmd --reload >/dev/null 2>&1
    echo -e "${GREEN}[‚úì] Firewall configured${NC}"
fi

echo -e "${YELLOW}[*] Starting service...${NC}"
systemctl start 3proxy

sleep 2

if systemctl is-active --quiet 3proxy; then
    echo -e "${GREEN}[‚úì] Service started${NC}"
else
    echo -e "${RED}[‚úó] Service failed. Check: journalctl -u 3proxy${NC}"
    exit 1
fi

gen_proxy_file
chown -R $REAL_USER:$REAL_USER "$PROXY_DIR"

echo ""
echo -e "${YELLOW}[*] Testing proxy...${NC}"
FIRST_PROXY=$(head -n 5 "$PROXY_DIR/proxy.txt" | tail -n 1)
if [[ -n "$FIRST_PROXY" ]]; then
    PROXY_IP=$(echo "$FIRST_PROXY" | cut -d: -f1)
    PROXY_PORT=$(echo "$FIRST_PROXY" | cut -d: -f2)
    PROXY_USER=$(echo "$FIRST_PROXY" | cut -d: -f3)
    PROXY_PASS=$(echo "$FIRST_PROXY" | cut -d: -f4)
    
    TEST_IP=$(curl -x "http://${PROXY_USER}:${PROXY_PASS}@${PROXY_IP}:${PROXY_PORT}" \
                   -s --max-time 10 https://api.ipify.org 2>/dev/null || echo "FAILED")
    
    if [[ "$TEST_IP" != "FAILED" ]] && [[ -n "$TEST_IP" ]]; then
        echo -e "${GREEN}[‚úì] Proxy working! IP: $TEST_IP${NC}"
    else
        echo -e "${YELLOW}[!] Test failed (check AWS Security Group)${NC}"
    fi
fi

echo ""
echo -e "${BLUE}=========================================${NC}"
echo -e "${BLUE}         INSTALLATION COMPLETE${NC}"
echo -e "${BLUE}=========================================${NC}"
echo ""
echo -e "${GREEN}‚úì Summary:${NC}"
echo "  ‚Ä¢ Type: IPv4 Proxy"
echo "  ‚Ä¢ IPv4: $IP4"
echo "  ‚Ä¢ Ports: $FIRST_PORT - $LAST_PORT"
echo "  ‚Ä¢ Total: $PROXY_COUNT proxies"
echo "  ‚Ä¢ List: $PROXY_DIR/proxy.txt"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Important Notes:${NC}"
echo "  ‚Ä¢ All proxies share SAME IPv4 address"
echo "  ‚Ä¢ Only port numbers differ"
echo "  ‚Ä¢ For unique IPs, need IPv6 /64 support"
echo "  ‚Ä¢ AWS EC2 does NOT support IPv6 /64"
echo ""
echo -e "${YELLOW}üìã Commands:${NC}"
echo "  cat $PROXY_DIR/proxy.txt     # View proxies"
echo "  systemctl status 3proxy      # Check status"
echo "  systemctl restart 3proxy     # Restart"
echo ""
echo -e "${GREEN}Sample proxy:${NC}"
head -n 6 "$PROXY_DIR/proxy.txt" | tail -n 1
echo "  ... ($((PROXY_COUNT - 1)) more with different ports)"
echo ""
